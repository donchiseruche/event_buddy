<!DOCTYPE html>
<html lang="de" class="h-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EventBuddy - Angebote</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 80px 0;
    }
    .btn-custom {
      border-radius: 50px;
      padding: 10px 22px;
      font-weight: 600;
      margin: 6px;
    }
    .feature-card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .feature-card:hover { transform: translateY(-5px); }

    /* Navbar */
    .navbar-dark { background:#0b1026 !important; }

    /* Karten / Badges */
    .event-card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      transition: transform .2s ease, box-shadow .2s ease;
      cursor: default;
    }
    .event-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    }
    .price-badge {
      border-radius: 999px;
      padding: .35rem .7rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-accom { background: #e8f5e9; color: #1b5e20; }
    .badge-ride  { background: #e0f2fe; color: #0c4a6e; }

    /* Suche / Filter */
    .filters-sticky {
      position: sticky;
      top: 0;
      z-index: 1020;
      background: #fff;
      border-bottom: 1px solid #eef2f7;
    }
    .search-input {
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      padding: .85rem 1rem;
    }
    .search-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .filter-btn {
      border-radius: 999px;
      border: 2px solid #e1e5e9;
      background: #fff;
      padding: .5rem 1rem;
      font-weight: 600;
    }
    .filter-btn.active {
      border-color: #4f46e5;
      color: #fff;
      background: #4f46e5;
    }

    @media (max-width: 576px) {
      .hero-section { padding: 64px 0; }
    }
  </style>
</head>
<body class="h-100 d-flex flex-column">

  <!-- Navbar responsive (identique à index.html) -->
  <nav class="navbar navbar-expand-md navbar-dark">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">EventBuddy</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Navigation umschalten">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <!-- Menu quand NON connecté -->
        <ul class="navbar-nav ms-auto align-items-md-center" id="guestNav">
          <li class="nav-item"><a class="nav-link" href="login.html">
            <i class="fas fa-right-to-bracket me-1"></i>Anmelden</a></li>
          <li class="nav-item ms-md-2">
            <a class="btn btn-outline-light btn-sm mt-2 mt-md-0" href="register.html">
              <i class="fas fa-user-plus me-1"></i>Registrieren
            </a>
          </li>
        </ul>

        <!-- Menu quand CONNECTÉ -->
        <ul class="navbar-nav ms-auto align-items-md-center d-none" id="userNav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="angebotDropdown" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              Angebot
            </a>
            <ul class="dropdown-menu" aria-labelledby="angebotDropdown">
              <li><a class="dropdown-item" href="angebot-erstellen.html">Angebot erstellen</a></li>
              <li><a class="dropdown-item" href="angebote.html">Liste der Angebote</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="chat.html">Chat</a></li>
          <li class="nav-item"><a class="nav-link" href="reservations.html">Meine Reservierungen</a></li>
          <li class="nav-item"><a class="nav-link" href="profile.html">Profil</a></li>
          <li class="nav-item ms-md-2">
            <a class="btn btn-light btn-sm mt-2 mt-md-0" href="#" id="logoutLink">
              <i class="fas fa-arrow-right-from-bracket me-1"></i>Abmelden
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <header class="hero-section text-center">
    <div class="container">
      <h1 class="display-5 fw-bold mb-3">Angebote</h1>
      <p class="lead mb-0">Unterkünfte und Fahrten von Studierenden – schnell finden und buchen</p>
    </div>
  </header>

  <!-- Suche & Filter (sticky) -->
  <section class="filters-sticky py-3">
    <div class="container">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-white border-0 ps-0">
              <i class="fas fa-magnifying-glass text-muted"></i>
            </span>
            <input id="searchInput" class="form-control search-input" type="search"
                   placeholder="Suche nach Ort, Abfahrt oder Ankunft…" aria-label="Angebote durchsuchen">
          </div>
        </div>
        <div class="col-12 col-md-6 text-md-end">
          <div class="btn-group" role="group" aria-label="Filter">
            <button class="filter-btn active" data-filter="all">Alle</button>
            <button class="filter-btn" data-filter="accommodation"><i class="fa-solid fa-bed me-1"></i>Unterkunft</button>
            <button class="filter-btn" data-filter="ride"><i class="fa-solid fa-car-side me-1"></i>Fahrt</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Angebote-Grid -->
  <section class="container my-4" id="offers">
    <div id="alertsArea" class="mb-3"></div>
    <div id="offersGrid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4"></div>
    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <i class="fas fa-box-open fa-2x mb-2" aria-hidden="true"></i>
      <p class="mb-0">Keine Angebote gefunden. Passe deine Suche oder Filter an.</p>
    </div>
  </section>

  <footer class="bg-dark text-light py-4 mt-auto">
    <div class="container text-center">
      <p>&copy; <span id="year"></span> EventBuddy. Alle Rechte vorbehalten.</p>
    </div>
  </footer>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
    // Jahr im Footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // === Auth UI (identique) ===
    function isLoggedIn() { return localStorage.getItem('eb_auth') === 'true'; }

    function updateNav() {
      const guestNav = document.getElementById('guestNav');
      const userNav  = document.getElementById('userNav');
      if (isLoggedIn()) {
        guestNav.classList.add('d-none');
        userNav.classList.remove('d-none');
      } else {
        userNav.classList.add('d-none');
        guestNav.classList.remove('d-none');
      }
    }

    function setupLogout() {
      const logout = document.getElementById('logoutLink');
      if (!logout) return;
      logout.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('eb_auth');
        localStorage.removeItem('eb_user');
        updateNav();
        document.querySelector('.navbar-toggler')?.click();
        window.location.href = 'index.html';
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateNav();
      setupLogout();
    });

    // === Angebote ===
    let ALL_OFFERS = [];

    async function loadOffers() {
      try {
        const res = await fetch('angebote.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        ALL_OFFERS = await res.json();
        applyFilters();
      } catch (err) {
        console.error('Angebote laden fehlgeschlagen:', err);
        document.getElementById('offersGrid').innerHTML =
          '<div class="col"><div class="alert alert-danger">Fehler beim Laden der Angebote.</div></div>';
      }
    }

    // Formatierungen
    const euro = (n) => `${n} €`;

    function seatsText(o) {
      const a = Number(o.seatsAvailable || 0);
      const t = Number(o.seatsTotal || 0);
      return `${a} / ${t} Plätze frei`;
    }

    function typeBadge(type) {
      const span = document.createElement('span');
      span.className = 'price-badge ' + (type === 'accommodation' ? 'badge-accom' : 'badge-ride');
      span.textContent = type === 'accommodation' ? 'Unterkunft' : 'Fahrt';
      return span;
    }

    // Rendering
   function renderOffers(list) {
    const grid = document.getElementById('offersGrid');
    const empty = document.getElementById('emptyState');
    grid.innerHTML = '';

    if (!list.length) {
      empty.classList.remove('d-none');
      return;
    }
    empty.classList.add('d-none');

    list.forEach(of => {
      const col = document.createElement('div');
      col.className = 'col';

      const card = document.createElement('div');
      card.className = 'card event-card h-100';
      card.setAttribute('role', 'article');

      const body = document.createElement('div');
      body.className = 'card-body d-flex flex-column';

      // Header: badge type + prix
      const headRow = document.createElement('div');
      headRow.className = 'd-flex justify-content-between align-items-start mb-2';

      const left = document.createElement('div');
      left.appendChild(typeBadge(of.type));

      const price = document.createElement('span');
      price.className = 'price-badge';
      price.textContent = euro(of.price);

      headRow.append(left, price);

      // Titre
      const title = document.createElement('h5');
      title.className = 'card-title mb-2';
      title.textContent = of.type === 'accommodation'
        ? (of.location || 'Unterkunft')
        : `${of.departure || '—'} → ${of.arrival || '—'}`;

      // Meta
      const meta = document.createElement('div');
      meta.className = 'small text-secondary mb-3';
      if (of.type === 'accommodation') {
        meta.innerHTML = `
          <div class="mb-1"><i class="fa-solid fa-location-dot me-2"></i>${of.location || '—'}</div>
          <div><i class="fa-solid fa-users me-2"></i>${seatsText(of)}</div>
        `;
      } else {
        meta.innerHTML = `
          <div class="mb-1"><i class="fa-solid fa-route me-2"></i>${of.departure || '—'} → ${of.arrival || '—'}</div>
          <div class="mb-1"><i class="fa-regular fa-clock me-2"></i>${of.departureTime || '—'} · ${of.duration || '—'}</div>
          <div><i class="fa-solid fa-users me-2"></i>${seatsText(of)}</div>
        `;
      }

      // Footer actions
      const footer = document.createElement('div');
      footer.className = 'mt-auto d-flex justify-content-between align-items-center';

      const leftInfo = document.createElement('span');
      leftInfo.className = 'text-muted small';
      leftInfo.textContent = of.type === 'accommodation' ? 'Unterkunft' : 'Fahrt';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-primary btn-sm';
      btn.innerHTML = '<i class="fa-solid fa-ticket me-1"></i> Reservieren';

      const noSeats = Number(of.seatsAvailable || 0) <= 0;
      if (noSeats) {
        btn.disabled = true;
        btn.classList.add('disabled');
        btn.innerHTML = '<i class="fa-solid fa-ban me-1"></i> Ausgebucht';
      }

      btn.addEventListener('click', () => onReserve(of));

      footer.append(leftInfo, btn);

      body.append(headRow, title, meta, footer);
      card.appendChild(body);
      col.appendChild(card);
      grid.appendChild(col);
    });
  }
    // Filter / Suche
    const state = {
      query: '',
      filter: 'all' // 'all' | 'accommodation' | 'ride'
    };

    function applyFilters() {
      const q = state.query.toLowerCase();

      const filtered = ALL_OFFERS.filter(of => {
        // Recherche
        const fields = [
          of.location || '',
          of.departure || '',
          of.arrival || ''
        ].join(' ').toLowerCase();

        const matchesQuery = !q || fields.includes(q);

        // Filtre type
        const matchesType =
          state.filter === 'all' ||
          of.type === state.filter;

        return matchesQuery && matchesType;
      });

      renderOffers(filtered);
    }

    // UI Handlers
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce((e) => {
      state.query = e.target.value.trim();
      applyFilters();
    }, 150));

    function debounce(fn, delay = 150) {
    let timer;
        return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(null, args), delay);
        };
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.filter = btn.dataset.filter;
        applyFilters();
      });
    });

    // Initial
    loadOffers();
    function showAlert(type, html) {
    const area = document.getElementById('alertsArea');
    const div = document.createElement('div');
    div.className = `alert alert-${type} alert-dismissible fade show`;
    div.innerHTML = html + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
    area.innerHTML = '';
    area.appendChild(div);
  }

  function saveOfferReservation(offer, userEmail) {
    const key = 'eb_offer_reservations';
    const all = JSON.parse(localStorage.getItem(key) || '[]');

    // éviter les doublons (même user, même offre)
    if (all.find(r => r.offerId === offer.id && r.email === userEmail)) {
      return { ok: false, reason: 'exists' };
    }

    all.push({
      offerId: offer.id,
      type: offer.type,
      price: offer.price,
      location: offer.location,
      departure: offer.departure,
      arrival: offer.arrival,
      duration: offer.duration,
      departureTime: offer.departureTime,
      email: userEmail,
      createdAt: new Date().toISOString()
    });
    localStorage.setItem(key, JSON.stringify(all));
    return { ok: true };
  }

  function onReserve(offer) {
    if (!isLoggedIn()) {
      showAlert('info', 'Bitte zuerst <a href="login.html" class="alert-link">anmelden</a>, um zu reservieren.');
      return;
    }

    const available = Number(offer.seatsAvailable || 0);
    if (available <= 0) {
      showAlert('warning', '<i class="fa-solid fa-circle-exclamation me-2"></i>Leider keine Plätze mehr verfügbar.');
      return;
    }

    const user = JSON.parse(localStorage.getItem('eb_user') || '{}');
    const res = saveOfferReservation(offer, user.email || 'unknown');

    if (!res.ok && res.reason === 'exists') {
      showAlert('secondary', '<i class="fa-regular fa-circle-check me-2"></i>Sie haben dieses Angebot bereits reserviert.');
      return;
    }

    // décrémenter localement et re-render
    offer.seatsAvailable = available - 1;
    showAlert('success', '<i class="fa-solid fa-check-circle me-2"></i>Reservierung erfolgreich!');
    applyFilters(); // re-render les cartes avec les nouvelles valeurs
  }
  </script>
</body>
</html>
