<!DOCTYPE html>
<html lang="de" class="h-100">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EventBuddy - Meine Reservierungen</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 80px 0;
    }
    .navbar-dark { background:#0b1026 !important; }

    .event-card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .event-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.12);
    }
    .badge-pill {
      border-radius: 999px;
      padding: .35rem .7rem;
      font-weight: 600;
      white-space: nowrap;
      border: 1px solid #e5e7eb;
      background: #fff;
    }
    .badge-kind-event { background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }
    .badge-kind-offer { background:#ecfeff; color:#155e75; border-color:#cffafe; }
    .badge-offer-accom { background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9; }
    .badge-offer-ride  { background:#e0f2fe; color:#0c4a6e; border-color:#bae6fd; }

    .search-input {
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      padding: .85rem 1rem;
    }
    .search-input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .filters-sticky {
      position: sticky;
      top: 0;
      z-index: 1020;
      background: #fff;
      border-bottom: 1px solid #eef2f7;
    }
    .filter-btn {
      border-radius: 999px;
      border: 2px solid #e1e5e9;
      background: #fff;
      padding: .5rem 1rem;
      font-weight: 600;
    }
    .filter-btn.active {
      border-color: #4f46e5;
      color: #fff;
      background: #4f46e5;
    }

    @media (max-width: 576px) {
      .hero-section { padding: 64px 0; }
    }
  </style>
</head>
<body class="h-100 d-flex flex-column">

  <!-- Navbar (même structure que les autres pages) -->
  <nav class="navbar navbar-expand-md navbar-dark">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">EventBuddy</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Navigation umschalten">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <!-- Gast -->
        <ul class="navbar-nav ms-auto align-items-md-center" id="guestNav">
          <li class="nav-item"><a class="nav-link" href="login.html">
            <i class="fas fa-right-to-bracket me-1"></i>Anmelden</a></li>
          <li class="nav-item ms-md-2">
            <a class="btn btn-outline-light btn-sm mt-2 mt-md-0" href="register.html">
              <i class="fas fa-user-plus me-1"></i>Registrieren
            </a>
          </li>
        </ul>

        <!-- Connecté -->
        <ul class="navbar-nav ms-auto align-items-md-center d-none" id="userNav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="angebotDropdown" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              Angebot
            </a>
            <ul class="dropdown-menu" aria-labelledby="angebotDropdown">
              <li><a class="dropdown-item" href="angebot-erstellen.html">Angebot erstellen</a></li>
              <li><a class="dropdown-item" href="angebote.html">Liste der Angebote</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="reservations.html">Meine Reservierungen</a></li>
          <li class="nav-item"><a class="nav-link" href="chat.html">Chat</a></li>
          <li class="nav-item"><a class="nav-link" href="profile.html">Profil</a></li>
          <li class="nav-item ms-md-2">
            <a class="btn btn-light btn-sm mt-2 mt-md-0" href="#" id="logoutLink">
              <i class="fas fa-arrow-right-from-bracket me-1"></i>Abmelden
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero-section text-center">
    <div class="container">
      <h1 class="display-6 fw-bold mb-2">Meine Reservierungen</h1>
      <p class="lead mb-0">Alle gebuchten Events und Angebote an einem Ort</p>
    </div>
  </header>

  <!-- Suche & Filter -->
  <section class="filters-sticky py-3">
    <div class="container">
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-white border-0 ps-0">
              <i class="fas fa-magnifying-glass text-muted"></i>
            </span>
            <input id="searchInput" class="form-control search-input" type="search"
                   placeholder="Suche nach Titel, Ort, Strecke…" aria-label="Reservierungen durchsuchen">
          </div>
        </div>
        <div class="col-12 col-md-6 text-md-end">
          <div class="btn-group" role="group" aria-label="Filter">
            <button class="filter-btn active" data-filter="all">Alle</button>
            <button class="filter-btn" data-filter="event"><i class="fa-solid fa-calendar-day me-1"></i>Events</button>
            <button class="filter-btn" data-filter="accommodation"><i class="fa-solid fa-bed me-1"></i>Unterkunft</button>
            <button class="filter-btn" data-filter="ride"><i class="fa-solid fa-car-side me-1"></i>Fahrt</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Liste -->
  <main class="container my-4 my-md-5 flex-grow-1">
    <div id="alertsArea" class="mb-3"></div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0">Gesamt: <span id="totalCount">0</span></h2>
      <button id="clearAllBtn" class="btn btn-outline-danger btn-sm">
        <i class="fa-regular fa-trash-can me-1"></i> Alle löschen
      </button>
    </div>

    <div id="reservationsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4"></div>

    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <i class="fa-regular fa-folder-open fa-2x mb-2"></i>
      <p class="mb-0">Keine Reservierungen vorhanden.</p>
    </div>
  </main>

  <footer class="bg-dark text-light py-4 mt-auto">
    <div class="container text-center">
      <p>&copy; <span id="year"></span> EventBuddy. Alle Rechte vorbehalten.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // === Auth ===
    function isLoggedIn() { return localStorage.getItem('eb_auth') === 'true'; }
    function updateNav() {
      const guestNav = document.getElementById('guestNav');
      const userNav  = document.getElementById('userNav');
      if (isLoggedIn()) { guestNav?.classList.add('d-none'); userNav?.classList.remove('d-none'); }
      else { userNav?.classList.add('d-none'); guestNav?.classList.remove('d-none'); }
    }
    function setupLogout() {
      document.getElementById('logoutLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('eb_auth');
        localStorage.removeItem('eb_user');
        window.location.href = 'index.html';
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (!isLoggedIn()) { window.location.replace('login.html'); return; }
      updateNav();
      setupLogout();
      loadAndRender();
    });

    // === Utils ===
    function debounce(fn, delay = 150) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), delay); };
    }
    const fmtEuro = (n) => (n === 0 ? 'Gratis' : `${n} €`);
    const toDateTime = (iso) => {
      try {
        const d = new Date(iso);
        return isNaN(d) ? '' : d.toLocaleString('de-DE', { dateStyle:'medium', timeStyle:'short' });
      } catch { return ''; }
    };

    // === Storage Keys ===
    const EV_KEY  = 'eb_reservations';       // côté events (créé par event.html)
    const OF_KEY  = 'eb_offer_reservations'; // côté offres (créé par angebote.html)

    function getUser() {
      try { return JSON.parse(localStorage.getItem('eb_user') || '{}'); } catch { return {}; }
    }
    function getEventReservations() {
      try { return JSON.parse(localStorage.getItem(EV_KEY) || '[]'); } catch { return []; }
    }
    function setEventReservations(arr) { localStorage.setItem(EV_KEY, JSON.stringify(arr)); }
    function getOfferReservations() {
      try { return JSON.parse(localStorage.getItem(OF_KEY) || '[]'); } catch { return []; }
    }
    function setOfferReservations(arr) { localStorage.setItem(OF_KEY, JSON.stringify(arr)); }

    // === Fusion en un modèle commun pour l'affichage ===
    function combineReservations() {
      const evs = getEventReservations().map(r => ({
        uid: `event:${r.eventId}:${r.email}:${r.bookedAt || ''}`,
        kind: 'event',
        type: null,
        title: r.title || 'Event',
        subtitle: r.location || '',
        price: r.price ?? null,
        line1: `${r.date || ''} · ${r.time || ''}`,
        line2: r.location || '',
        extra: (r.types || []).join(', '),
        link: r.eventId ? `event.html?id=${encodeURIComponent(r.eventId)}` : null,
        bookedAt: r.bookedAt || null,
        raw: r
      }));

      const ofs = getOfferReservations().map(r => {
        const isRide = r.type === 'ride';
        return {
          uid: `offer:${r.offerId}:${r.email}:${r.createdAt || ''}`,
          kind: 'offer',
          type: r.type || null, // 'accommodation' | 'ride'
          title: isRide ? `${r.departure || '—'} → ${r.arrival || '—'}` : (r.location || 'Unterkunft'),
          subtitle: isRide ? (r.location || '') : (r.location || ''),
          price: r.price ?? null,
          line1: isRide ? `${r.departureTime || '—'} · ${r.duration || '—'}` : (r.location || ''),
          line2: isRide ? `${r.departure || '—'} → ${r.arrival || '—'}` : '',
          extra: isRide ? 'Fahrt' : 'Unterkunft',
          link: null, // pas de page détail pour offers (optionnel)
          bookedAt: r.createdAt || null,
          raw: r
        };
      });

      // trier par date de réservation (desc)
      const all = [...evs, ...ofs].sort((a, b) => {
        const ta = a.bookedAt ? Date.parse(a.bookedAt) : 0;
        const tb = b.bookedAt ? Date.parse(b.bookedAt) : 0;
        return tb - ta;
      });
      return all;
    }

    // === Rendu ===
    let ALL = [];
    const state = { query: '', filter: 'all' }; // all | event | accommodation | ride

    function render(list) {
      const grid = document.getElementById('reservationsGrid');
      const empty = document.getElementById('emptyState');
      const total = document.getElementById('totalCount');
      grid.innerHTML = '';

      total.textContent = String(list.length);
      if (!list.length) { empty.classList.remove('d-none'); return; }
      empty.classList.add('d-none');

      list.forEach(item => {
        const col = document.createElement('div');
        col.className = 'col';

        const card = document.createElement('div');
        card.className = 'card event-card h-100';

        const body = document.createElement('div');
        body.className = 'card-body d-flex flex-column';

        // header badges
        const head = document.createElement('div');
        head.className = 'd-flex justify-content-between align-items-start mb-2';

        const left = document.createElement('div');
        const kindBadge = document.createElement('span');
        kindBadge.className = 'badge-pill ' + (item.kind === 'event' ? 'badge-kind-event' : 'badge-kind-offer');
        kindBadge.textContent = item.kind === 'event' ? 'Event' : 'Angebot';
        left.appendChild(kindBadge);

        if (item.kind === 'offer' && item.type) {
          const t = document.createElement('span');
          t.className = 'badge-pill ms-2 ' + (item.type === 'ride' ? 'badge-offer-ride' : 'badge-offer-accom');
          t.textContent = item.type === 'ride' ? 'Fahrt' : 'Unterkunft';
          left.appendChild(t);
        }

        const price = document.createElement('span');
        price.className = 'badge-pill';
        price.textContent = (item.price == null) ? '—' : fmtEuro(item.price);

        head.append(left, price);

        // title
        const title = document.createElement('h5');
        title.className = 'card-title mb-1';
        title.textContent = item.title;

        // subtitle
        const sub = document.createElement('div');
        sub.className = 'text-muted small mb-2';
        sub.textContent = item.subtitle || '';

        // meta
        const meta = document.createElement('div');
        meta.className = 'small text-secondary';
        meta.innerHTML = `
          <div class="mb-1"><i class="fa-regular fa-clock me-2"></i>${item.line1 || '—'}</div>
          ${item.line2 ? `<div class="mb-1"><i class="fa-solid fa-location-dot me-2"></i>${item.line2}</div>` : ''}
          ${item.extra ? `<div><i class="fa-solid fa-tag me-2"></i>${item.extra}</div>` : ''}
        `;

        // footer actions
        const footer = document.createElement('div');
        footer.className = 'mt-auto d-flex justify-content-between align-items-center pt-2';

        const booked = document.createElement('span');
        booked.className = 'text-muted small';
        booked.innerHTML = `<i class="fa-regular fa-calendar-check me-1"></i> gebucht am ${toDateTime(item.bookedAt)}`;

        const btns = document.createElement('div');
        if (item.link) {
          const open = document.createElement('a');
          open.className = 'btn btn-outline-primary btn-sm me-2';
          open.href = item.link;
          open.innerHTML = '<i class="fa-regular fa-eye me-1"></i> Details';
          btns.appendChild(open);
        }

        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'btn btn-outline-danger btn-sm';
        del.innerHTML = '<i class="fa-regular fa-trash-can me-1"></i> Löschen';
        del.addEventListener('click', () => onDelete(item));
        btns.appendChild(del);

        footer.append(booked, btns);

        body.append(head, title, sub, meta, footer);
        card.appendChild(body);
        col.appendChild(card);
        grid.appendChild(col);
      });
    }

    function applyFilters() {
      const q = state.query.toLowerCase();

      const filtered = ALL.filter(x => {
        // search fields
        const hay = [
          x.title || '', x.subtitle || '',
          x.line1 || '', x.line2 || '', x.extra || ''
        ].join(' ').toLowerCase();
        const matchesQ = !q || hay.includes(q);

        // type filter
        const matchesF =
          state.filter === 'all' ||
          (state.filter === 'event' && x.kind === 'event') ||
          (state.filter === 'accommodation' && x.kind === 'offer' && x.type === 'accommodation') ||
          (state.filter === 'ride' && x.kind === 'offer' && x.type === 'ride');

        return matchesQ && matchesF;
      });

      render(filtered);
    }

    // === Actions ===
    function showAlert(type, html) {
      const area = document.getElementById('alertsArea');
      const div = document.createElement('div');
      div.className = `alert alert-${type} alert-dismissible fade show`;
      div.innerHTML = html + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
      area.innerHTML = '';
      area.appendChild(div);
    }

    function onDelete(item) {
      if (!confirm('Diese Reservierung wirklich löschen?')) return;

      if (item.kind === 'event') {
        const list = getEventReservations();
        const filtered = list.filter(r =>
          `event:${r.eventId}:${r.email}:${r.bookedAt || ''}` !== item.uid
        );
        setEventReservations(filtered);
      } else {
        const list = getOfferReservations();
        const filtered = list.filter(r =>
          `offer:${r.offerId}:${r.email}:${r.createdAt || ''}` !== item.uid
        );
        setOfferReservations(filtered);
      }

      showAlert('success', '<i class="fa-solid fa-check-circle me-2"></i>Reservierung gelöscht.');
      loadAndRender();
    }

    function clearAll() {
      if (!ALL.length) return;
      if (!confirm('Alle Reservierungen löschen?')) return;
      setEventReservations([]);
      setOfferReservations([]);
      showAlert('success', '<i class="fa-solid fa-check-circle me-2"></i>Alle Reservierungen wurden gelöscht.');
      loadAndRender();
    }

    // === Load & wire ===
    function loadAndRender() {
      ALL = combineReservations();
      applyFilters();
    }

    document.getElementById('clearAllBtn').addEventListener('click', clearAll);

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce(e => {
      state.query = e.target.value.trim();
      applyFilters();
    }, 150));

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.filter = btn.dataset.filter;
        applyFilters();
      });
    });
  </script>
</body>
</html>
