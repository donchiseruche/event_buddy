<!DOCTYPE html>
<html lang="de" class="h-100">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EventBuddy - Profil</title>

  <!-- Bootstrap & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    .hero-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 64px 0;
    }
    .navbar-dark { background:#0b1026 !important; }

    .card-soft {
      border: none;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .avatar-lg {
      width: 84px; height: 84px;
      border-radius: 50%;
      object-fit: cover;
      background:#eef2ff;
      display:flex; align-items:center; justify-content:center;
      font-weight: 700; color:#4338ca;
      font-size: 28px;
    }
    .form-soft .form-control, .form-soft .form-select {
      border:2px solid #e1e5e9; border-radius:12px; padding:.9rem .95rem;
    }
    .form-soft .form-control:focus, .form-soft .form-select:focus {
      border-color:#4f46e5; box-shadow:0 0 0 3px rgba(79,70,229,.1);
    }
    .badge-pill {
      border-radius:999px; padding:.35rem .7rem; font-weight:600;
      background:#f1f5f9; color:#334155;
    }
    @media (max-width: 576px) {
      .hero-section { padding: 48px 0; }
    }
  </style>
</head>
<body class="h-100 d-flex flex-column">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="index.html">EventBuddy</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Navigation umschalten">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <!-- Gast -->
        <ul class="navbar-nav ms-auto align-items-md-center" id="guestNav">
          <li class="nav-item"><a class="nav-link" href="login.html">
            <i class="fas fa-right-to-bracket me-1"></i>Anmelden</a></li>
          <li class="nav-item ms-md-2">
            <a class="btn btn-outline-light btn-sm mt-2 mt-md-0" href="register.html">
              <i class="fas fa-user-plus me-1"></i>Registrieren
            </a>
          </li>
        </ul>

        <!-- Connecté -->
        <ul class="navbar-nav ms-auto align-items-md-center d-none" id="userNav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="angebotDropdown" role="button"
              data-bs-toggle="dropdown" aria-expanded="false">
              Angebot
            </a>
            <ul class="dropdown-menu" aria-labelledby="angebotDropdown">
              <li><a class="dropdown-item" href="angebot-erstellen.html">Angebot erstellen</a></li>
              <li><a class="dropdown-item" href="angebote.html">Liste der Angebote</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="chat.html">Chat</a></li>
          <li class="nav-item"><a class="nav-link" href="reservations.html">Meine Reservierungen</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="profile.html">Profil</a></li>
          <li class="nav-item ms-md-2">
            <a class="btn btn-light btn-sm mt-2 mt-md-0" href="#" id="logoutLink">
              <i class="fas fa-arrow-right-from-bracket me-1"></i>Abmelden
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <header class="hero-section">
    <div class="container">
      <h1 class="h3 fw-bold mb-1">Profil</h1>
      <p class="mb-0">Verwalte deine persönlichen Daten und sieh deine Aktivität.</p>
    </div>
  </header>

  <main class="container my-4 my-md-5 flex-grow-1">
    <div id="alertsArea" class="mb-3"></div>

    <div class="row g-4">
      <!-- Linke Spalte: Profilkarte + Aktivität -->
      <div class="col-lg-4">
        <div class="card card-soft p-3 p-md-4 mb-4">
          <div class="d-flex align-items-center gap-3">
            <div id="avatarBox" class="avatar-lg">U</div>
            <div>
              <div id="userName" class="fw-semibold">Nutzer</div>
              <div id="userEmail" class="text-muted small">email@example.com</div>
            </div>
          </div>

          <hr class="my-3"/>

          <div class="small">
            <div class="d-flex justify-content-between">
              <span class="text-muted">Rolle</span>
              <span id="userRole" class="badge-pill">—</span>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span class="text-muted">Telefon</span>
              <span id="userPhone">—</span>
            </div>
          </div>
        </div>

        <div class="card card-soft p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Aktivität</h6>
            <span class="text-muted small">Übersicht</span>
          </div>
          <div class="mt-3 small">
            <div class="d-flex justify-content-between">
              <span><i class="fa-solid fa-ticket me-2"></i>Event-Reservierungen</span>
              <strong id="statEvents">0</strong>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span><i class="fa-solid fa-car-side me-2"></i>Angebot-Reservierungen</span>
              <strong id="statOffers">0</strong>
            </div>
          </div>
          <div class="mt-3">
            <a href="reservations.html" class="btn btn-outline-primary btn-sm w-100">
              <i class="fa-solid fa-list-check me-1"></i> Alle Reservierungen ansehen
            </a>
          </div>
        </div>
      </div>

      <!-- Rechte Spalte: Formular -->
      <div class="col-lg-8">
        <div class="card card-soft p-3 p-md-4">
          <h5 class="mb-3">Profil bearbeiten</h5>

          <form id="profileForm" class="form-soft" novalidate>
            <!-- Avatar -->
            <div class="mb-3">
              <label class="form-label">Profilbild</label>
              <div class="d-flex align-items-center gap-3">
                <img id="avatarPreview" class="avatar-lg d-none" alt="Avatar Vorschau"/>
                <div id="avatarInitials" class="avatar-lg">U</div>
                <div>
                  <input type="file" id="avatarInput" accept="image/*" class="form-control form-control-sm"/>
                  <div class="form-text">Optional. Bild wird lokal gespeichert (Simulation).</div>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="firstName" class="form-label">Vorname</label>
                <input id="firstName" type="text" class="form-control" required/>
              </div>
              <div class="col-md-6">
                <label for="lastName" class="form-label">Nachname</label>
                <input id="lastName" type="text" class="form-control" required/>
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required/>
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">Telefon</label>
                <input id="phone" type="tel" class="form-control" placeholder="+49 ..."/>
              </div>
              <div class="col-md-6">
                <label for="role" class="form-label">Rolle</label>
                <select id="role" class="form-select">
                  <option value="student">Student/in</option>
                  <option value="organizer">Organisator/in</option>
                </select>
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-floppy-disk me-1"></i> Speichern
              </button>
              <button type="button" id="resetBtn" class="btn btn-outline-secondary">
                Zurücksetzen
              </button>
            </div>

            <hr class="my-4"/>

            <h5 class="mb-3">Passwort</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="pwd1" class="form-label">Neues Passwort</label>
                <input id="pwd1" type="password" class="form-control" minlength="6"/>
              </div>
              <div class="col-md-6">
                <label for="pwd2" class="form-label">Neues Passwort bestätigen</label>
                <input id="pwd2" type="password" class="form-control" minlength="6"/>
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button type="button" id="pwdBtn" class="btn btn-outline-primary">
                <i class="fa-solid fa-key me-1"></i> Passwort aktualisieren
              </button>
            </div>
            <div class="form-text mt-2">Nur Simulation – es wird nichts auf einem Server geändert.</div>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-dark text-light py-4 mt-auto">
    <div class="container text-center">
      <p>&copy; <span id="year"></span> EventBuddy. Alle Rechte vorbehalten.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Footer-Jahr
    document.getElementById('year').textContent = new Date().getFullYear();

    // === Auth / Navbar ===
    function isLoggedIn(){ return localStorage.getItem('eb_auth') === 'true'; }
    function updateNav(){
      const guestNav = document.getElementById('guestNav');
      const userNav  = document.getElementById('userNav');
      if (isLoggedIn()){ guestNav?.classList.add('d-none'); userNav?.classList.remove('d-none'); }
      else { userNav?.classList.add('d-none'); guestNav?.classList.remove('d-none'); }
    }
    function setupLogout(){
      document.getElementById('logoutLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('eb_auth');
        localStorage.removeItem('eb_user');
        window.location.href = 'index.html';
      });
    }

    // === User helpers ===
    const USER_KEY = 'eb_user';
    function getUser(){
      try { return JSON.parse(localStorage.getItem(USER_KEY) || '{}'); }
      catch { return {}; }
    }
    function setUser(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }

    function initialsFromName(name){
      return (name || 'U')
        .split(' ')
        .filter(Boolean)
        .map(s => s[0])
        .slice(0,2)
        .join('')
        .toUpperCase();
    }

    function showAlert(type, html){
      const area = document.getElementById('alertsArea');
      const div = document.createElement('div');
      div.className = 'alert alert-' + type + ' alert-dismissible fade show';
      div.innerHTML = html + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
      area.innerHTML = '';
      area.appendChild(div);
    }

    // === Stats (reservations) ===
    function loadStats(){
      let eventsCount = 0, offersCount = 0;
      try {
        const u = getUser();
        const ev = JSON.parse(localStorage.getItem('eb_reservations') || '[]');
        const of = JSON.parse(localStorage.getItem('eb_offer_reservations') || '[]');
        eventsCount = ev.filter(r => r.email === u.email).length;
        offersCount = of.filter(r => r.email === u.email).length;
      } catch(e){}
      document.getElementById('statEvents').textContent = eventsCount;
      document.getElementById('statOffers').textContent = offersCount;
    }

    // === Form & UI binding ===
    const form = document.getElementById('profileForm');
    const firstName = document.getElementById('firstName');
    const lastName  = document.getElementById('lastName');
    const email     = document.getElementById('email');
    const phone     = document.getElementById('phone');
    const role      = document.getElementById('role');

    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarInitials = document.getElementById('avatarInitials');
    const avatarBox = document.getElementById('avatarBox');

    function fillHeader(u){
      const fullName = [u.firstName, u.lastName].filter(Boolean).join(' ') || 'Nutzer';
      document.getElementById('userName').textContent = fullName;
      document.getElementById('userEmail').textContent = u.email || '—';
      document.getElementById('userRole').textContent = (u.role === 'organizer' ? 'Organisator/in' : 'Student/in');
      document.getElementById('userPhone').textContent = u.phone || '—';

      // Avatar in Headerkarte
      if (u.avatarDataUrl){
        avatarBox.innerHTML = '';
        const img = document.createElement('img');
        img.src = u.avatarDataUrl; img.alt = 'Avatar'; img.className = 'avatar-lg';
        avatarBox.appendChild(img);
      } else {
        avatarBox.textContent = initialsFromName(fullName);
      }
    }

    function fillForm(u){
      firstName.value = u.firstName || '';
      lastName.value  = u.lastName  || '';
      email.value     = u.email     || '';
      phone.value     = u.phone     || '';
      role.value      = u.role      || 'student';

      if (u.avatarDataUrl){
        avatarPreview.src = u.avatarDataUrl;
        avatarPreview.classList.remove('d-none');
        avatarInitials.classList.add('d-none');
      } else {
        avatarPreview.classList.add('d-none');
        avatarInitials.classList.remove('d-none');
        const fullName = [u.firstName, u.lastName].filter(Boolean).join(' ');
        avatarInitials.textContent = initialsFromName(fullName);
      }
    }

    function handleAvatarChange(e){
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        avatarPreview.src = ev.target.result;
        avatarPreview.classList.remove('d-none');
        avatarInitials.classList.add('d-none');
      };
      reader.readAsDataURL(file);
    }

    avatarInput.addEventListener('change', handleAvatarChange);

    function validateEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      // simple validation
      if (!firstName.value.trim() || !lastName.value.trim()){
        showAlert('danger', '<ul class="mb-0"><li>Vor- und Nachname sind erforderlich.</li></ul>');
        return;
      }
      if (!validateEmail(email.value.trim())){
        showAlert('danger', '<ul class="mb-0"><li>Bitte eine gültige Email eingeben.</li></ul>');
        return;
      }

      const current = getUser();
      const updated = {
        ...current,
        firstName: firstName.value.trim(),
        lastName:  lastName.value.trim(),
        email:     email.value.trim(),
        phone:     phone.value.trim(),
        role:      role.value,
      };

      // persist avatar if eine Vorschau sichtbar ist
      if (!avatarPreview.classList.contains('d-none') && avatarPreview.src){
        updated.avatarDataUrl = avatarPreview.src;
      } else if (current.avatarDataUrl){
        updated.avatarDataUrl = current.avatarDataUrl; // unverändert
      }

      setUser(updated);
      fillHeader(updated);
      showAlert('success', '<i class="fa-solid fa-check-circle me-2"></i>Profil erfolgreich aktualisiert.');
      loadStats();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      fillForm(getUser());
      showAlert('secondary', 'Änderungen verworfen.');
    });

    // Passwort (Simulation)
    document.getElementById('pwdBtn').addEventListener('click', () => {
      const p1 = document.getElementById('pwd1').value;
      const p2 = document.getElementById('pwd2').value;
      if (!p1 || p1.length < 6){
        showAlert('danger', 'Das Passwort muss mindestens 6 Zeichen lang sein.');
        return;
      }
      if (p1 !== p2){
        showAlert('danger', 'Passwörter stimmen nicht überein.');
        return;
      }
      // Simulation only
      showAlert('success', '<i class="fa-solid fa-key me-2"></i>Passwort aktualisiert (Simulation).');
      document.getElementById('pwd1').value = '';
      document.getElementById('pwd2').value = '';
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      if (!isLoggedIn()){
        window.location.replace('login.html');
        return;
      }
      updateNav();
      setupLogout();

      // Nutzer laden oder Demo-User anlegen falls leer
      let u = getUser();
      if (!u || !u.email){
        u = { firstName:'Test', lastName:'User', email:'test@test.com', role:'student' };
        setUser(u);
      }
      fillHeader(u);
      fillForm(u);
      loadStats();
    });
  </script>
</body>
</html>
